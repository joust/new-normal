<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <link rel="apple-touch-icon" href="images/nn-icon.png">
    <link rel="icon" type="image/png" href="images/nn-icon.png">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="stylesheet" href="opensans.css">
    <link rel="stylesheet" href="crocodile.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="flipside.css">
    <link rel="stylesheet" href="pyro.css">
    <title>New Normal</title>
    <script src="bingo.js" type="text/javascript"></script>
    <script src="flipside.js" type="text/javascript"></script>
    <script src="fastclick.js" type="application/javascript"></script>
  </head>
  <body onload="load()">
    <div><button id="stop" class="hidden" onclick="stop()">&#x274c;</button></div>
    <div id="menu">
      <div class="game-logo menu">
        <div class="logo">
          <span class="red">New N</span><span class="virus"></span><span class="blue">rmal</span>
          <select id="location" onchange="load(event.target.value)">
            <option title="Deutschland" value="de-de">🇩🇪</option>
            <option title="Österreich" value="de-at">🇦🇹</option>
            <option title="Schweiz" value="de-ch">🇨🇭</option>
            <option title="United States" value="en-us">🇺🇸</option>
            <option title="United Kingdom" value="en-gb">🇬🇧</option>
            <option title="Australia" value="en-au">🇦🇺</option>
            <option title="New Zealand" value="en-nz">🇳🇿</option>
            <option title="Polska" disabled value="pl-pl">🇵🇱</option>
            <option title="España" value="es-es" disabled>🇪🇸</option>
            <option title="France" value="fr-fr" disabled>🇫🇷</option>
          </select>
        </div>
      </div>
      <div class="content"></div>
    </div>
    <div id="game" class="flip-wrapper hidden">
      <div id="wrapper-1" class="flip card-wrapper">
        <div class="card flip-front">
          <button class="reload">&#x21bb;</button>
          <div class="title"></div>
          <div class="bingo"></div>
        </div>
        <div class="detail flip-back" onclick="handleClick(event)">
          <div class="content"></div>
        </div>
      </div>
      <div id="wrapper-2" class="flip card-wrapper">
        <div class="card flip-front">
          <button class="reload">&#x21bb;</button>
          <div class="title"></div>
          <div class="bingo"></div>
        </div>
        <div class="detail flip-back" onclick="handleClick(event)">
          <div class="content"></div>
        </div>
      </div>
    </div>
    <div id="pyro" class="hidden" onclick="stopPyro()">
      <div class="before"></div>
      <div class="after"></div>
    </div>
    <script type="text/javascript">
      if (!('fetch' in window)) alert('Please user a modern Browser to play New Normal!')
      const attitude = { hasty: false, curious: true, open: false, fair: false, friendly: false }
      let lang, terr
      
      /**
       * start the app with the given locale and start the matching intro
       *
       * @param {?string} locale optional locale string like 'de-de'. if not present, browser locale is used
       */
      function load(locale) {
        FastClick.attach(document.body)
        loadAttitude()
        const [language, territory] = [lang, terr] = locale ? locale.split('-') : browserLocale()
        document.querySelector('#location').value = lang + '-' + terr
        if (attitude.hasty) show('start'); else runIntro()
      }

      /**
       * load and show the given page by patching innerHTML of element '#menu content'
       *
       * @param {string} page name of the page to load
       */
      async function show(page) {
        document.querySelector('.logo').style.display = page === 'intro' ? 'none' : 'block'
        document.querySelector('#menu').classList.add('hidden')
        document.querySelector('#menu .content').innerHTML = await (await fetch(lang +'/'+page+'.html')).text()
        document.querySelector('#menu').scrollTop = 0
        if (page==='attitude') initAttitude()
        setTimeout(() => document.querySelector('#menu').classList.remove('hidden'), 50)
      }
      let timer = null

      /**
       * run intro by a timed display of its frames. can be skipped with skipIntro()
       */
      async function runIntro() {
        await show('intro')
        document.querySelector('#menu').classList.add('intro')
        let frame = document.querySelector('#menu .frame')
        const nextFrame = () => {
          frame.classList.toggle('show')
          frame = frame.nextElementSibling
          if (frame) {
            frame.classList.toggle('show')
            timer = setTimeout(nextFrame, 60 * frame.textContent.length)
          } else {
            timer = null
            document.querySelector('#menu').classList.remove('intro')
            show('start')
          }
        }
        frame.classList.toggle('show')
        timer = setTimeout(nextFrame, 60 * frame.textContent.length)
      }

      /**
       * skip intro by stopping its timer and show the start menu
       */
      function skipIntro() {
        if (timer) clearTimeout(timer)
        saveAttitude('hasty', true)
        document.querySelector('#menu').classList.remove('intro')
        show('start')
      }

      /**
       * stop the pyro effect by setting CSS 'hidden' class
       */
      function stopPyro() {
        document.querySelector('#pyro').classList.add('hidden')
      }
      
      /**
       * transfer the current attitude to the attitude page for editing
       */
      function initAttitude() {
        for (let a in attitude)
          document.querySelector(`#menu #${a}`).checked = attitude[a]
      }

      /**
       * save a single attitude locally and to local storage if available
       */
      function saveAttitude(a, value) {
        attitude[a] = value
        if (localStorage)
          localStorage.setItem(a, attitude[a] ? 'true' : 'false')
      }

      /**
       * load all attitudes from local storage if available
       */
      function loadAttitude() {
        if (localStorage)
          for (let a in attitude)
            if (localStorage.getItem(a) !== undefined)
              attitude[a] = localStorage.getItem(a)==='true'
      }

      /**
       * create one or two idiot or sheep cards and start the game
       *
       * @param {boolean} one create a idiot card if true, otherwise a sheep card
       * @param {?boolean} two create a second card, idiot if true, sheep if false
       */
      function play(one, two) {
        loadCard('#wrapper-1', one)
        if (two !== undefined) {
          document.querySelector('#wrapper-2').classList.remove('hidden')
          document.querySelector('#game').classList.remove('one')
          loadCard('#wrapper-2', two)
        } else {
          document.querySelector('#wrapper-2').classList.add('hidden')
          document.querySelector('#game').classList.add('one')
        }

        document.querySelector('#stop').classList.remove('hidden')
        document.querySelector('#game').classList.remove('hidden')
        document.querySelector('#menu').classList.add('hidden')
      }

      /**
       * load a card by fetching the needed content (idiot/sheep + local) from the server
       *
       * @param {HTMLElement} wrapper wrapper element to load the card into
       * @param {boolean} idiot load idiot content if true, otherwise sheep content
       */
      async function loadCard(wrapper, idiot) {
        const langfile = lang + (idiot ? '/idiot.html' : '/sheep.html')
        const langcontent = await (await fetch(langfile)).text()
        const terrfile = terr + (idiot ? '/idiot-local.html' : '/sheep-local.html')
        const terrcontent = await (await fetch(terrfile)).text()
        wrapper = document.querySelector(wrapper)
        wrapper.querySelector('.content').innerHTML = langcontent + terrcontent
        wrapper.querySelectorAll('a[id]').forEach(a =>
          a.prepend(elementWithKids('span', a.id)) // add id tags
        )
        const sources = elementWithKids('div')
        sources.innerHTML = await (await fetch('sources.html')).text()
        addSources(wrapper, sources)
        if (attitude.open)
         wrapper.querySelectorAll('.content button, .content button + a').forEach(e => e.remove())
        if (attitude.friendly)
          wrapper.querySelectorAll('i, .content button').forEach(e => e.remove())
      
        const set = getArguments(wrapper.querySelector('.detail'))
        if (!set.length) alert('No arguments found!')
        makeCard(wrapper, set, 5, idiot ? '🤪,👻' : '🐑,😷')
        wrapper.querySelector('.card').classList.toggle('redbg', idiot)
        wrapper.querySelector('.card').classList.toggle('bluebg', !idiot)
        wrapper.querySelector('.reload').onclick = () => makeCard(wrapper, set, 5, idiot ? '🤪,👻' : '🐑,😷')
        // prepare card title
        const title = wrapper.querySelector('.title')
        if (title.firstChild) title.removeChild(title.firstChild)
        const select = wrapper.querySelector('.detail select')
        if (!attitude.fair)
          randomElement(select.querySelectorAll('option'), 1).selected = true
        title.appendChild(select)
        
        // copy logo
        wrapper.querySelector('.content').prepend(
          document.querySelector('.logo').cloneNode(true))
        wrapper.querySelector('.logo').removeChild(wrapper.querySelector('.logo select'))
      }

      /**
       * stop the game, hiding the #game element and showing the #menu element
       */
      function stop() {
        document.querySelector('#stop').classList.add('hidden')
        document.querySelector('#game').classList.add('hidden')
        document.querySelector('#menu').classList.remove('hidden')
      }

      /**
       * handle a click on the details window
       * @param {Event} event the click event
       */
      function handleClick(event) {
        if (event.target.tagName.toLowerCase() === 'a') {
          showSources(event)
        } else {
          showSources(event, false)
          closeDetails(event)
        }
      }
      
      /**
       * open the detail window, adding the CSS 'single' classes to the given id details
       * @param {Event} event the event that triggered the open action
       */
      function openDetails(event) {
        const detail = event.target.closest('.card-wrapper').querySelector('.detail')
        const anchor = detail.querySelector(`a[id=${event.target.id}]`)
        detail.classList.add('single'), anchor.classList.add('single')
        detail.querySelectorAll('button, button + a').forEach(e => e.classList.toggle('hidden',
          attitude.open || !anchor.nextElementSibling.querySelector('q')))
        flipOpen(event)
      }
      
      /**
       * close the detail window, removing the CSS 'single' classes
       * @param {Event} event the event that triggered the close action
       */
      function closeDetails(event) {
        flipClose(event)
        const detail = event.target.closest('.card-wrapper').querySelector('.detail')
        detail.classList.remove('single')
        detail.querySelectorAll('a[id]').forEach(e => e.classList.remove('single'))
      }

      /**
       * extract the argument ids and texts from HTML content
       *
       * @param {HTMLElement} detail content DOM node containing the arguments
       * @return {{id: string, word: string}[]} the extracted arguments
       */
      function getArguments(detail) {
        return Array.from(detail.querySelectorAll('a[id]')).map(
          a => ({id: a.id, word: a.querySelector('h2').innerHTML}))
      }
      
      /**
       * show/hide all sources boxes if available
       *
       * @param {Event} event the Event triggering the action
       * @param {boolean} show true if the sources should be made visible false otherwise
       */
      function showSources(event, show = true) {
        const detail = event.target.closest('.card-wrapper').querySelector('.detail')
        if (!attitude.open)
          detail.querySelectorAll('q').forEach(q => q.classList.toggle('hidden', !show))
        detail.querySelectorAll('button, button + a').forEach(e => e.classList.add('hidden'))
      }
      
      /**
       * extend the arguments in detail with sources from sources if available
       *
       * @param {HTMLElement} detail content DOM node containing the arguments
       * @param {HTMLElement} sources content DOM node containing the sources
       */
      function addSources(detail, sources) {
        Array.from(detail.querySelectorAll('a[id]')).forEach(a => {
          const links = sources.querySelectorAll(`a.${a.id}`)
          links.forEach(link => link.target = '_blank')
          if (links.length > 0) {
            const q = elementWithKids('q', elementWithKids('ul', Array.from(links).map(
              s => elementWithKids('li',s.cloneNode(true)))))
            if (!attitude.open) q.classList.add('hidden')
            a.nextElementSibling.appendChild(q)
          }
        })
      }

      /**
       * get browser two-character-codes for language and territory in lower case
       *
       * @return {string[]} an 2-entry-array with the browser language and territory
       */
      function browserLocale() {
        let [language, territory] = navigator.language.split('-')
        territory = territory ? territory.toLowerCase() : language
        return [language, territory]
      }
    </script>
  </body>
</html>
