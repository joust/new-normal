<!DOCTYPE html>
<html>
  <head>
  <title>New Normal - Corona-Uno</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="opensans.css">
  <link rel="stylesheet" href="crocodile.css">
  <link rel="stylesheet" href="components/cards.css">
  <script src="dialog.js" type="text/javascript"></script>
  <script src="components/flip-card.js" type="text/javascript"></script>
  <script src="components/game-card.js" type="text/javascript"></script>
  <script src="components/sources-back.js" type="text/javascript"></script>
  <script src="components/argument-card.js" type="text/javascript"></script>
  <script src="components/test-card.js" type="text/javascript"></script>
  <script src="components/test-pile.js" type="text/javascript"></script>
  <script src="components/no-card.js" type="text/javascript"></script>
  <script src="common.js" type="text/javascript"></script>
  <script src="fastclick.js" type="text/javascript"></script>
  <style>
    html, body, #uno {
      font-family: 'Open Sans', Helvetica;
      font-size: 3vmin;
      position: fixed;
      height: 100%;
      width: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .hidden {
      display: none;
    }

    #test, test-pile {
      width: 420px;
      height: 600px;
    }
  </style>
</head>
<body onload="flagcheck(); load()">
  <script>
    async function load(locale) {
      FastClick.attach(document.body)
      if (locale) [lang, terr] = locale.split('-'); else [lang, terr] = browserLocale()
      if (!supported.includes(lang)) [lang, terr] = ['en', 'us']
      document.body.lang = lang
      await loadSources()
      await loadContent(lang)
      document.getElementById('test').insertAdjacentHTML('afterBegin', '<test-pile id="test-pile" cards="T1:I1,T2:S2,T3:I3,T4:S4"></test-card>')
      document.getElementById('test-pile').addEventListener('finish', event => finish(event))
    }

    function finish(event) {
      console.log(event.detail)
    }
    
    function flagcheck() {
      if (navigator.userAgent.indexOf('Windows') > 0)
        document.head.innerHTML += '<link rel="stylesheet" href="noto.css">'
    }

    async function loadSources() {
      const loaded = document.querySelector('#content > .sources')
      if (!loaded) {
        const sources = elementWithKids('div', null, { 'class': 'sources' })
        document.querySelector('#content').appendChild(sources)
        sources.innerHTML = await fetchSilent(`sources.html`)
        Array.from(sources.querySelectorAll('a')).forEach(link => link.target = '_blank')
      }
    }

    async function loadContent(lang) {
      const loaded = document.querySelector(`#content > #${lang}`)
      if (!loaded) {
        const root = elementWithKids('div', [
          elementWithKids('div', null, { 'class': 'idiot' }),
          elementWithKids('div', null, { 'class': 'sheep' }),
          elementWithKids('div', null, { 'class': 'topics' })
        ], { id: lang })
        document.querySelector('#content').appendChild(root)
        const [idiot, sheep, topics] = await Promise.all([
          fetchSilent(`${lang}/idiot.html`),
          fetchSilent(`${lang}/sheep.html`),
          fetchSilent(`${lang}/topics.html`)
        ])
        root.querySelector('.idiot').innerHTML =  replaceStatement(lang, idiot)
        root.querySelector('.sheep').innerHTML = replaceStatement(lang, sheep)
        root.querySelector('.topics').innerHTML = topics
      }
    }
    
    function replaceStatement(lang, content) {
      const from1 = {
        de: 'Die sagen<i> doch allen Ernstes</i>',
        en: 'They say<i> in all seriousness</i>',
        fr: 'Ils disent<i> en toute sincérité</i>',
        es: 'Dicen<i> con toda seriedad</i>',
        it: 'Dicono<i> in tutta serietà</i>',
        da: 'De siger<i> med al alvor</i>',
        pl: 'Twierdzą<i> z całą powagą</i>',
        pt: 'Dizem<i> com toda a seriedade</i>',
        'pt-br': 'Dizem<i> com toda a seriedade</i>'
      }
      const to1 = {
        de: 'Ich bin bei denen, die sagen',
        en: 'I am with those who say',
        fr: 'Je suis avec ceux qui disent',
        es: 'Estoy con quienes dicen',
        it: 'Sono d\'accordo con chi dice',
        da: 'Jeg er enig med dem, der siger',
        pl: 'Jestem z tymi, którzy twierdzą',
        pt: 'Estou com aqueles que dizem',
        'pt-br': 'Estou com aqueles que dizem'
      }
      const from2 = {
        de: 'Die fragen<i> doch allen Ernstes</i>',
        en: 'They ask<i> in all seriousness</i>',
        fr: 'Ils demandent<i> en toute sincérité</i>',
        es: 'Preguntan<i> con toda seriedad</i>',
        it: 'Chiedono<i> in tutta serietà</i>',
        da: 'De spørger<i> med al alvor</i>',
        pl: 'Pytają<i> z całą powagą</i>',
        pt: 'Pergunta<i> com toda a seriedade</i>',
        'pt-br': 'Pergunta<i> com toda a seriedade</i>'

      }
      const to2 = {
        de: 'Ich bin bei denen, die fragen',
        en: 'I am with those who ask',
        fr: 'Je suis avec ceux qui demandent',
        es: 'Estoy con quienes preguntan',
        it: 'Sono d\'accordo con chi chiedono',
        da: 'Jeg er enig med dem, der spørger',
        pl: 'Jestem z tymi, którzy pytają',
        pt: 'Estou com aqueles que perguntam',
        'pt-br': 'Estou com aqueles que perguntam'
      }
      return content.replaceAll(from1[lang], to1[lang]).replaceAll(from2[lang], to2[lang])
    }
  </script>
  <div id="test">
  </div>
  <div id="content" class="hidden">
  </div>
  <div id="loader" class="hidden"></div>
</body>
</html>
