<!DOCTYPE html>
<html>
  <head>
  <title>New Normal - Corona-Uno</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="opensans.css">
  <link rel="stylesheet" href="crocodile.css">
  <link rel="stylesheet" href="uno.css">
  <link rel="stylesheet" href="components/cards.css">
  <script src="dialog.js" type="text/javascript"></script>
  <script src="components/player-hand.js" type="text/javascript"></script>
  <script src="components/opponent-hand.js" type="text/javascript"></script>
  <script src="components/argument-card.js" type="text/javascript"></script>
  <script src="components/no-card.js" type="text/javascript"></script>
  <script src="components/card-pile.js" type="text/javascript"></script>
  <script src="components/game-card.js" type="text/javascript"></script>
  <script src="components/card-back.js" type="text/javascript"></script>
  <script src="components/label-card.js" type="text/javascript"></script>
  <script src="components/fallacy-card.js" type="text/javascript"></script>
  <script src="components/strawman-card.js" type="text/javascript"></script>
  <script src="components/appeal-to-card.js" type="text/javascript"></script>
  <script src="components/research-card.js" type="text/javascript"></script>
  <script src="components/discuss-card.js" type="text/javascript"></script>
  <script src="components/pause-card.js" type="text/javascript"></script>
  <script src="common.js" type="text/javascript"></script>
  <script src="fastclick.js" type="text/javascript"></script>
</head>
<body onload="flagcheck(); randomMatchId(); load()">
  <script src="boardgame.js"></script>
  <script src="uno.js"></script>
  <script>
    function element(id) {
      return document.getElementById(id)
    }
    function elements(tag) {
      return Array.from(document.getElementsByTagName(tag))
    }
    
    function randomMatchId() {
      element('matchID').value = Math.floor(1000+Math.random()*9000)
    }
    
    async function load(locale) {
      FastClick.attach(document.body)
      if (locale) [lang, terr] = locale.split('-'); else [lang, terr] = browserLocale()
      if (!supported.includes(lang)) [lang, terr] = ['en', 'us']
      document.querySelector('#location').value = `${lang}-${terr}`
      document.body.lang = lang
      await loadContent(lang)
      element('instructions').innerHTML = await fetchSilent(`${lang}/uno.html`)
      if (!element('game'))
        element('uno').insertAdjacentHTML('afterBegin', `
          <div id="game">
            <div id="players">
            </div>
            <div id="piles">
              <card-pile id="draw-pile" top="I"></card-pile>
              <card-pile id="pile"></card-pile>
            </div>
          </div>`)
    }
    
    let setNameRequestSent = false
    async function sendSetNameRequest(client, playerID) {
      setNameRequestSent = true
      const name = await prompt(`Name for Player ${playerID}?`, '')
      client.sendChatMessage({ message: 'setName', name })
    }
    
    function addOpponentHand(nr, name) {
      element('players').insertAdjacentHTML('beforeEnd', `<opponent-hand cards="8" nr="${nr}" ${name ? `name="${name}"` : ''}></opponent-hand>`)
    }
    
    function cardsString(hand, decks, content, top, current, idiot) {
      // JSON array of id+alternative elements in format { id: '...', alt: ['...', '...'], playable }
      return JSON.stringify(hand.map(card => (
        { card,
          alt: getAlternatives(card, decks, content),
          playable: current && canBePlayedOn(top, card, idiot)
        })))
    }
    
    function updateTable(client, state) { // TODO move to uno/game-table.js component
      const top = state.G.pile[state.G.pile.length-1]
      element('draw-pile').setAttribute('top', '')
      element('pile').setAttribute('top', top)
      const opponentIds = [...Array(state.ctx.numPlayers).keys()].filter(id => id!=client.playerID) // number!=string
      const name = state.G.names[client.playerID]
      const hand = state.G.hands[client.playerID]
      const idiot = !!(client.playerID%2)
      const deck = idiot ? state.G.decks.idiot : state.G.decks.sheep
      const current = client.playerID===state.ctx.currentPlayer
      element('draw-pile').setAttribute('top', idiot ? 'I' : 'S')
      element('hand').setAttribute('cards', cardsString(hand, state.G.decks, client.game.content, top, current, idiot))
      element('hand').setAttribute('nr', client.playerID)
      element('hand').setAttribute('name', state.G.names[client.playerID])
      element('hand').classList.toggle('current', state.ctx.currentPlayer===client.playerID)
      if (name) element('hand').setAttribute('name', name)
      Array.from(element('players').children).forEach((hand, index) => {
        hand.setAttribute('nr', opponentIds[index])
        hand.classList.toggle('current', state.ctx.currentPlayer===opponentIds[index])
        if (state.G.names[opponentIds[index]]) 
          hand.setAttribute('name', state.G.names[opponentIds[index]])
        hand.setAttribute('cards', state.G.hands[opponentIds[index]].length)
      })
    }

    function makeBotMove(client, botID, state) {
      if (state.ctx.currentPlayer===botID) {
        const idiot = isIdiot(botID)
        const hand = state.G.hands[botID]
        const top = state.G.pile.length ? state.G.pile[state.G.pile.length-1] : undefined
        const possibleMoves = allPossibleMoves(hand, idiot, top)
        const randomMoveIndex = Math.floor(Math.random()*possibleMoves.length)
        const move = possibleMoves[randomMoveIndex]
        setTimeout(() => client.moves[move.move](...move.args), 500)
      }
    }
    
    async function playWithBot(idiot) {
      const lang = document.body.lang
      const playerID = idiot ? '1' : '0'
      const botID = idiot ? '0' : '1'
      element('uno').classList.toggle('hidden', false)
      element('config').classList.toggle('hidden', true)
      const clients = await startLocal(lang, playerID)
      await loadContent(lang)
      element('uno').insertAdjacentHTML('beforeEnd', `<player-hand id="hand" nr="${playerID}" cards="[]"></player-hand>`)
      addOpponentHand(botID, 'CPU')
      clients[playerID].moves.setName(playerID, 'Me')
      clients[playerID].moves.setName(botID, 'CPU')
      element('draw-pile').onclick = event => clients[playerID].moves.drawCard()
      element('hand').onplay = event => clients[playerID].moves.playCard(event.detail.index, event.detail.card)
      clients[playerID].subscribe(state => updateTable(clients[playerID], state))
      clients[botID].subscribe(state => makeBotMove(clients[botID], botID, state))
    }
    
    async function play(isHost, numPlayers) {
      const lang = document.body.lang
      const idiot = element('idiot').checked
      const hostPlayerID = idiot ? '1' : '0'
      const playerID = isHost ? hostPlayerID : undefined
      const matchID = element('matchID').value
      element('uno').classList.toggle('hidden', false)
      element('config').classList.toggle('hidden', true)
      element('players').classList.add(`p${numPlayers}`)
      let client = await startClient(lang, isHost, numPlayers, playerID, matchID)
      if (isHost) {
        element('uno').insertAdjacentHTML('beforeEnd', '<player-hand id="hand" nr="0" cards="[]"></player-hand>')
        client.moves.setName(playerID, await prompt(`Name for Host Player?`, ''))
        element('draw-pile').onclick = event => client.moves.drawCard()
        element('hand').onplay = event => client.moves.playCard(event.detail.index, event.detail.card)
        const opponentPlayerIds = [...Array(numPlayers).keys()].filter(id => id!=playerID)
        opponentPlayerIds.forEach(id => addOpponentHand(id, '?'))
      }
      
      const setNameRequest = msg => msg.payload.message==='setName'
      let unsubscribe
      const stateHandler = async state => {
        if (state) {
          if (client.playerID) {
            if (!isHost && !setNameRequestSent && state.ctx.currentPlayer===hostPlayerID) { // first call after guest select
              await sendSetNameRequest(client, client.playerID)
            }
            updateTable(client, state)
            if (isHost && state.ctx.currentPlayer===hostPlayerID) {
              client.chatMessages.filter(setNameRequest).forEach(msg => {
                if (state.G.names[msg.sender]!=msg.payload.name) {
                  client.moves.setName(msg.sender, msg.payload.name)
                }
              }
              )
            }
          } else {
            const hostPlayerID = state.G.host
            const hostPlayerName = state.G.names[state.G.host]
            const takeSeat = (client, playerID) => { 
              elements('opponent-hand').forEach(child => child.classList.remove('selectable'))
              client.updatePlayerID(playerID)
              updateTable(client, state)              
              element('draw-pile').onclick = event => client.moves.drawCard()
              element('hand').onplay = event => client.moves.playCard(event.detail.index, event.detail.card)
            }

            if (!element('players').children.length) { // first call in a guest (no playerID set)
              element('players').classList.add(`p${state.ctx.numPlayers}`)
              await load(document.body.lang = state.G.lang)
              element('uno').insertAdjacentHTML('beforeEnd', `<player-hand id="hand"></opponent-hand>`)
              if (state.ctx.numPlayers===2) {
                addOpponentHand(hostPlayerID, state.G.names[hostPlayerID])
                takeSeat(client, hostPlayerID==='0' ? '1' : '0')
              } else {
                const selectablePlayerIds = state.ctx.playOrder.filter(id => id!==hostPlayerID)
                selectablePlayerIds.forEach(id => addOpponentHand(id, state.G.names[id]))
                elements('opponent-hand').forEach(child => child.classList.add('selectable'))
                elements('opponent-hand').forEach((child, index) => child.onclick = async event => takeSeat(client, selectablePlayerIds[index]))
              }
            }
          }
        }
      }
      
      unsubscribe = client.subscribe(stateHandler)
    }

    function flagcheck() {
      if (navigator.userAgent.indexOf('Windows') > 0)
        document.head.innerHTML += '<link rel="stylesheet" href="noto.css">'
    }

    function fixAnchors(html) {
      return html.replaceAll('</h2></a>', '</h2>').replaceAll('</p>', '</p></a>')
    }

    async function loadContent(lang) {
      const loaded = document.querySelector(`#content > #${lang}`)
      if (!loaded) {
        const root = elementWithKids('div', [
          elementWithKids('div', null, { 'class': 'idiot' }),
          elementWithKids('div', null, { 'class': 'sheep' }),
          elementWithKids('div', null, { 'class': 'labels' }),
          elementWithKids('div', null, { 'class': 'appeal-tos' }),
          elementWithKids('div', null, { 'class': 'fallacies' }),
          elementWithKids('div', null, { 'class': 'topics' })
        ], { id: lang })
        document.querySelector('#content').appendChild(root)
        const [idiot, sheep, labels, appealTos, fallacies, topics] = await Promise.all([
          fetchSilent(`${lang}/idiot.html`),
          fetchSilent(`${lang}/sheep.html`),
          fetchSilent(`${lang}/labels.html`),
          fetchSilent(`${lang}/appeal-tos.html`),
          fetchSilent(`${lang}/fallacies.html`),
          fetchSilent(`${lang}/topics.html`)
        ])
        root.querySelector('.idiot').innerHTML =  fixAnchors(replaceStatement(lang, idiot))
        root.querySelector('.sheep').innerHTML = fixAnchors(replaceStatement(lang, sheep))
        root.querySelector('.labels').innerHTML = labels
        root.querySelector('.appeal-tos').innerHTML = appealTos
        root.querySelector('.fallacies').innerHTML = fallacies
        root.querySelector('.topics').innerHTML = topics
      }
    }
    
    function replaceStatement(lang, content) {
      const from1 = {
        de: 'Die sagen<i> doch allen Ernstes</i>',
        en: 'They say<i> in all seriousness</i>',
        fr: 'Ils disent<i> en toute sincérité</i>',
        es: 'Dicen<i> con toda seriedad</i>',
        it: 'Dicono<i> in tutta serietà</i>',
        da: 'De siger<i> med al alvor</i>',
        pl: 'Twierdzą<i> z całą powagą</i>',
        pt: 'Dizem<i> com toda a seriedade</i>',
        'pt-br': 'Dizem<i> com toda a seriedade</i>'
      }
      const to1 = {
        de: 'Ich bin bei denen, die sagen',
        en: 'I am with those who say',
        fr: 'Je suis avec ceux qui disent',
        es: 'Estoy con quienes dicen',
        it: 'Sono d\'accordo con chi dice',
        da: 'Jeg er enig med dem, der siger',
        pl: 'Jestem z tymi, którzy twierdzą',
        pt: 'Estou com aqueles que dizem',
        'pt-br': 'Estou com aqueles que dizem'
      }
      const from2 = {
        de: 'Die fragen<i> doch allen Ernstes</i>',
        en: 'They ask<i> in all seriousness</i>',
        fr: 'Ils demandent<i> en toute sincérité</i>',
        es: 'Preguntan<i> con toda seriedad</i>',
        it: 'Chiedono<i> in tutta serietà</i>',
        da: 'De spørger<i> med al alvor</i>',
        pl: 'Pytają<i> z całą powagą</i>',
        pt: 'Pergunta<i> com toda a seriedade</i>',
        'pt-br': 'Pergunta<i> com toda a seriedade</i>'
        
      }
      const to2 = {
        de: 'Ich bin bei denen, die fragen',
        en: 'I am with those who ask',
        fr: 'Je suis avec ceux qui demandent',
        es: 'Estoy con quienes preguntan',
        it: 'Sono d\'accordo con chi chiedono',
        da: 'Jeg er enig med dem, der spørger',
        pl: 'Jestem z tymi, którzy pytają',
        pt: 'Estou com aqueles que perguntam',
        'pt-br': 'Estou com aqueles que perguntam'
      }
      return content.replaceAll(from1[lang], to1[lang]).replaceAll(from2[lang], to2[lang])
    }
  </script>
  <div id="uno" class="hidden"></div>
  <div id="config">
    <h1>Corona-Uno</h1>
    <div className="row">
      <label>
        Language
          <select id="location" onchange="load(event.target.value)">
            <option title="Deutschland" value="de-de">🇩🇪</option>
            <option title="Österreich" value="de-at">🇦🇹</option>
            <option title="Schweiz" value="de-ch">🇨🇭</option>
            <option title="Svizzera" value="it-ch">🇨🇭</option>
            <option title="Suisse" value="fr-ch">🇨🇭</option>
            <option title="Danmark" value="da-da">🇩🇰</option>
            <option title="Liechtenstein" value="de-li">🇱🇮</option>
            <option title="Italia" value="it-it">🇮🇹</option>
            <option title="Italien" value="de-it">🇮🇹</option>
            <option title="San Marino" value="it-sm">🇸🇲</option>
            <option title="Città del Vaticano" value="it-va">🇻🇦</option>
            <option title="United States" value="en-us">🇺🇸</option>
            <option title="United Kingdom" value="en-gb">🇬🇧</option>
            <option title="Australia" value="en-au">🇦🇺</option>
            <option title="New Zealand" value="en-nz">🇳🇿</option>
            <option title="Canada" value="en-ca">🇨🇦</option>
            <option title="Canada" value="fr-ca">🇨🇦</option>
            <option title="Polska" value="pl-pl">🇵🇱</option>
            <option title="Antigua and Barbuda" value="en-ag">🇦🇬</option>
            <option title="The Bahamas" value="en-bs">🇧🇸</option>
            <option title="Barbados" value="en-bb">🇧🇧</option>
            <option title="Belize" value="en-bz">🇧🇿 </option>
            <option title="Dominica" value="en-dm">🇩🇲</option>
            <option title="Grenada" value="en-gd">🇬🇩</option>
            <option title="Guyana" value="en-gy">🇬🇾</option>
            <option title="Ireland" value="en-ie">🇮🇪</option>
            <option title="Jamaica" value="en-jm">🇯🇲</option>
            <option title="Malta" value="en-mt">🇲🇹</option>
            <option title="St Kitts and Nevis" value="en-kn">🇰🇳</option>
            <option title="St Lucia" value="en-lc">🇱🇨</option>
            <option title="St Vincent and the Grenadines" value="en-vc">🇻🇨</option>
            <option title="Trinidad and Tobago" value="en-tt">🇹🇹</option>
            <option title="España" value="es-es">🇪🇸</option>
            <option title="Cuba" value="es-cu">🇨🇺</option>
            <option title="Perú" value="es-pe">🇵🇪</option>
            <option title="Chile" value="es-cl">🇨🇱</option>
            <option title="México" value="es-mx">🇲🇽</option>
            <option title="Puerto Rico" value="es-pr">🇵🇷</option>
            <option title="Argentina" value="es-ar">🇦🇷</option>
            <option title="Bolivia" value="es-bo">🇧🇴</option>
            <option title="Colombia" value="es-co">🇨🇴</option>
            <option title="Costa Rica" value="es-cr">🇨🇷</option>
            <option title="República Dominicana" value="es-do">🇩🇴</option>
            <option title="Ecuador" value="es-ec">🇪🇨</option>
            <option title="El Salvador" value="es-sv">🇸🇻</option>
            <option title="Guinea Ecuatorial" value="es-gq">🇬🇶</option>
            <option title="Guatemala" value="es-gt">🇬🇹</option>
            <option title="Honduras" value="es-hn">🇭🇳</option>
            <option title="Nicaragua" value="es-ni">🇳🇮</option>
            <option title="Panama" value="es-pa">🇵🇦</option>
            <option title="Paraguay" value="es-py">🇵🇾</option>
            <option title="Uruguay" value="es-uy">🇺🇾</option>
            <option title="Venezuela" value="es-ve">🇻🇪</option>
            <option title="Portugual" value="pt-pt">🇵🇹</option>
            <option title="Brasil" value="pt-br">🇧🇷</option>
            <option title="Angola" value="pt-ao">🇦🇴</option>
            <option title="Moçambique" value="pt-mz">🇲🇿</option>
            <option title="Guiné-Bissau" value="pt-gw">🇬🇼</option>
            <option title="São Tomé &amp; Príncipe" value="pt-st">🇸🇹</option>
            <option title="Cabo Verde" value="pt-cv">🇨🇻</option>
            <option title="France" value="fr-fr">🇫🇷</option>
            <option title="België" value="nl-be">🇧🇪</option>
            <option title="Belgien" value="de-be">🇧🇪</option>
            <option title="Belgique" value="fr-be">🇧🇪</option>
            <option title="Congo" value="fr-cd">🇨🇩</option>
            <option title="Congo" value="fr-cg">🇨🇬</option>
            <option title="Côte d’Ivoire" value="fr-ko">🇨🇮</option>
            <option title="Madagascar" value="fr-ko">🇲🇬</option>
            <option title="Cameroun" value="fr-cm">🇨🇲</option>
            <option title="Cameroon" value="en-cm">🇨🇲</option>
            <option title="Burkina Faso" value="fr-bf">🇧🇫</option>
            <option title="Niger" value="fr-ne">🇳🇪</option>
            <option title="Mali" value="fr-ml">🇲🇱</option>
            <option title="Sénégal" value="fr-sn">🇸🇳</option>
            <option title="Haïti" value="fr-ht">🇭🇹</option>
            <option title="Benin" value="fr-bj">🇧🇯</option>
          </select>
      </label>
    <hr>
      <label>
        Match#
        <input id="matchID" type="text" maxlength="4" minlength="4" size="5">
        Role
        <input type="radio" id="idiot" name="role" value="idiot" checked>
        <label for="idiot">Idiot</label>
        <input type="radio" id="sheep" name="role" value="sheep">
        <label for="sheep">Sheep</label>
      </label>
    </div>
      <label>
        Host
    <button onclick="play(true, 2)">2</button>
    <button onclick="play(true, 4)">4</button>
    <button onclick="play(true, 6)">6</button>
    <button onclick="play(true, 8)">8</button>
    <button onclick="play(true, 10)">10</button>
        Guest
    <button onclick="play(false)">Join</button>
      </label>
    <hr>
      <label>
        Local
    <button onclick="playWithBot(true)">Against Bot as Idiot</button>
    <button onclick="playWithBot(false)">Against Bot as Sheep</button>
      </label>
    <div id="instructions"></div>
  </div>
<div id="content" class="hidden">
</div>
<div id="loader" class="hidden"></div>
</body>
</html>