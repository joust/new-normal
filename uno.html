<!DOCTYPE html>
<html>
  <head>
  <title>New Normal - Corona-Uno</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="opensans.css">
  <link rel="stylesheet" href="crocodile.css">
  <link rel="stylesheet" href="uno.css">
  <script src="uno/player-hand.js" type="text/javascript"></script>
  <script src="uno/opponent-hand.js" type="text/javascript"></script>
  <script src="uno/argument-card.js" type="text/javascript"></script>
  <script src="uno/no-card.js" type="text/javascript"></script>
  <script src="uno/card-pile.js" type="text/javascript"></script>
  <script src="uno/game-card.js" type="text/javascript"></script>
  <script src="uno/card-back.js" type="text/javascript"></script>
  <script src="uno/label-card.js" type="text/javascript"></script>
  <script src="uno/fallacy-card.js" type="text/javascript"></script>
  <script src="uno/strawman-card.js" type="text/javascript"></script>
  <script src="uno/appeal-to-card.js" type="text/javascript"></script>
  <script src="uno/research-card.js" type="text/javascript"></script>
  <script src="common.js" type="text/javascript"></script>
  <script src="swipy.js" type="text/javascript"></script>
  <script src="fastclick.js" type="text/javascript"></script>
</head>
<body onload="load()">
  <script src="boardgame.js"></script>
  <script src="uno.js"></script>
  <script src="app.js"></script>
  <script>
    function element(id) {
      return document.getElementById(id)
    }
    function elements(tag) {
      return Array.from(document.getElementsByTagName(tag))
    }
    
    async function load() {
      const randomMatchID = Math.floor(1000+Math.random()*9000)
      element('matchID').value = randomMatchID
      await loadContent('de')
      element('uno').insertAdjacentHTML('afterBegin', `
      <div id="game">
        <div id="players">
        </div>
        <div id="piles">
          <card-pile id="draw-pile" top="I"></card-pile>
          <card-pile id="pile" top=""></card-pile>
        </div>
      </div>
      <player-hand id="hand" active ids=""></player-hand>`)
    }
    
    async function play(isHost, numPlayers) {
      const addOpponentHand = (clickable) => element('players').insertAdjacentHTML('beforeEnd', `<opponent-hand ${clickable ? 'style="cursor:pointer"' : ''} cards="8"></opponent-hand>`)
      const playerID = isHost ? '0' : undefined
      const matchID = element('matchID').value
      element('uno').classList.toggle('hidden', false)
      element('config').classList.toggle('hidden', true)
      let client = await startClient('de', isHost, numPlayers, playerID, matchID)
      if (playerID) {
        client.moves.setName(prompt(`Name for Host Player?`, ''))
        element('hand').setAttribute('nr', playerID)
        element('draw-pile').onclick = event => client.moves.drawCard()
        element('hand').onplay = event => client.moves.playCard(event.detail.index)
        while (--numPlayers) addOpponentHand(false)
      }
      
      async function setMyName(client, currentPlayer) {
        const clientName = prompt(`Name for Player ${client.playerID}?`, '')
        client.events.endTurn({ next: client.playerID })
        client.moves.setName(clientName)
        client.events.endTurn({ next: currentPlayer })
      }
      
      let unsubscribe
      const stateHandler = state => {
        if (state) {
          const top = state.G.pile[state.G.pile.length-1]
          element('draw-pile').setAttribute('top', '')
          element('pile').setAttribute('top', top)
          if (client.playerID && client.playerID.length) {
            const name = state.G.names[client.playerID]
            const hand = state.G.hands[client.playerID]
            const idiot = !!(client.playerID%2)
            const opponentIds = [...Array(state.ctx.numPlayers).keys()].filter(id => id!==client.playerID)
            if (!name && state.ctx.currentPlayer!==client.playerID)
              setTimeout(() => setMyName(client, state.ctx.currentPlayer), 0) // leave callback first
            element('draw-pile').setAttribute('top', idiot ? 'I' : 'S')
            element('hand').setAttribute('ids', hand.join(','))
            element('hand').setAttribute('nr', client.playerID)
            element('hand').setAttribute('name', name)
            element('hand').setAttribute('playable', client.playerID===state.ctx.currentPlayer ? hand.filter(card => canBePlayedOn(top, card, idiot)).join(',') : '')
            elements('opponent-hand').forEach((hand, index) => {
              hand.setAttribute('nr', opponentIds[index])
              hand.setAttribute('name', state.G.names[opponentIds[index]])
              hand.setAttribute('cards', state.G.hands[opponentIds[index]].length)
            })
            if (client.playerID==='0' && !state.G.names[state.ctx.currentPlayer]) {
              console.log(client)
              client.step && client.step() // CPU move
            }
          } else {
            if (!element('players').children.length) { // first call
              let numPlayers = state.ctx.numPlayers
              while (--numPlayers) addOpponentHand(true)
              const children = Array.from(element('players').children)
              children.forEach((child, index) => child.onclick = async event => {
                const selectedPlayerID = ''+(index+1)
                console.log(selectedPlayerID)
                client.stop()
                unsubscribe()
                client = await startClient('de', false, numPlayers, selectedPlayerID, matchID)
                unsubscribe = client.subscribe(stateHandler)
                element('draw-pile').onclick = event => client.moves.drawCard()
                element('hand').onplay = event => client.moves.playCard(event.detail.index)
              })
            }
          }
        }
      }
      
      unsubscribe = client.subscribe(stateHandler)
    }

  </script>
  <div id="uno" class="hidden"></div>
  <div id="config">
    <h2>Select Match ID and either host or join</h2>
    <div className="row">
      <label>
        <code>Match ID</code>
        <input id="matchID" type="text">
      </label>
    </div>
    <hr>
    <button onclick="play(true, 2)">Host 2</button>
    <button onclick="play(true, 4)">Host 4</button>
    <button onclick="play(true, 6)">Host 6</button>
    <button onclick="play(true, 8)">Host 8</button>
    <button onclick="play(true, 10)">Host 10</button>
    <hr>
    <button onclick="play(false)">Join</button>
  </div>
  <select id="location" onchange="uno(event.target.value)">
  <option title="Deutschland" value="de-de">ğŸ‡©ğŸ‡ª</option>
  <option title="Ã–sterreich" value="de-at">ğŸ‡¦ğŸ‡¹</option>
  <option title="Schweiz" value="de-ch">ğŸ‡¨ğŸ‡­</option>
  <option title="Svizzera" value="it-ch">ğŸ‡¨ğŸ‡­</option>
  <option title="Suisse" value="fr-ch">ğŸ‡¨ğŸ‡­</option>
  <option title="Danmark" value="da-da">ğŸ‡©ğŸ‡°</option>
  <option title="Liechtenstein" value="de-li">ğŸ‡±ğŸ‡®</option>
  <option title="Italia" value="it-it">ğŸ‡®ğŸ‡¹</option>
  <option title="Italien" value="de-it">ğŸ‡®ğŸ‡¹</option>
  <option title="San Marino" value="it-sm">ğŸ‡¸ğŸ‡²</option>
  <option title="CittÃ  del Vaticano" value="it-va">ğŸ‡»ğŸ‡¦</option>
  <option title="United States" value="en-us">ğŸ‡ºğŸ‡¸</option>
  <option title="United Kingdom" value="en-gb">ğŸ‡¬ğŸ‡§</option>
  <option title="Australia" value="en-au">ğŸ‡¦ğŸ‡º</option>
  <option title="New Zealand" value="en-nz">ğŸ‡³ğŸ‡¿</option>
  <option title="Canada" value="en-ca">ğŸ‡¨ğŸ‡¦</option>
  <option title="Canada" value="fr-ca">ğŸ‡¨ğŸ‡¦</option>
  <option title="Polska" value="pl-pl">ğŸ‡µğŸ‡±</option>
  <option title="Antigua and Barbuda" value="en-ag">ğŸ‡¦ğŸ‡¬</option>
  <option title="The Bahamas" value="en-bs">ğŸ‡§ğŸ‡¸</option>
  <option title="Barbados" value="en-bb">ğŸ‡§ğŸ‡§</option>
  <option title="Belize" value="en-bz">ğŸ‡§ğŸ‡¿ </option>
  <option title="Dominica" value="en-dm">ğŸ‡©ğŸ‡²</option>
  <option title="Grenada" value="en-gd">ğŸ‡¬ğŸ‡©</option>
  <option title="Guyana" value="en-gy">ğŸ‡¬ğŸ‡¾</option>
  <option title="Ireland" value="en-ie">ğŸ‡®ğŸ‡ª</option>
  <option title="Jamaica" value="en-jm">ğŸ‡¯ğŸ‡²</option>
  <option title="Malta" value="en-mt">ğŸ‡²ğŸ‡¹</option>
  <option title="St Kitts and Nevis" value="en-kn">ğŸ‡°ğŸ‡³</option>
  <option title="St Lucia" value="en-lc">ğŸ‡±ğŸ‡¨</option>
  <option title="St Vincent and the Grenadines" value="en-vc">ğŸ‡»ğŸ‡¨</option>
  <option title="Trinidad and Tobago" value="en-tt">ğŸ‡¹ğŸ‡¹</option>
  <option title="EspaÃ±a" value="es-es">ğŸ‡ªğŸ‡¸</option>
  <option title="Cuba" value="es-cu">ğŸ‡¨ğŸ‡º</option>
  <option title="PerÃº" value="es-pe">ğŸ‡µğŸ‡ª</option>
  <option title="Chile" value="es-cl">ğŸ‡¨ğŸ‡±</option>
  <option title="MÃ©xico" value="es-mx">ğŸ‡²ğŸ‡½</option>
  <option title="Puerto Rico" value="es-pr">ğŸ‡µğŸ‡·</option>
  <option title="Argentina" value="es-ar">ğŸ‡¦ğŸ‡·</option>
  <option title="Bolivia" value="es-bo">ğŸ‡§ğŸ‡´</option>
  <option title="Colombia" value="es-co">ğŸ‡¨ğŸ‡´</option>
  <option title="Costa Rica" value="es-cr">ğŸ‡¨ğŸ‡·</option>
  <option title="RepÃºblica Dominicana" value="es-do">ğŸ‡©ğŸ‡´</option>
  <option title="Ecuador" value="es-ec">ğŸ‡ªğŸ‡¨</option>
  <option title="El Salvador" value="es-sv">ğŸ‡¸ğŸ‡»</option>
  <option title="Guinea Ecuatorial" value="es-gq">ğŸ‡¬ğŸ‡¶</option>
  <option title="Guatemala" value="es-gt">ğŸ‡¬ğŸ‡¹</option>
  <option title="Honduras" value="es-hn">ğŸ‡­ğŸ‡³</option>
  <option title="Nicaragua" value="es-ni">ğŸ‡³ğŸ‡®</option>
  <option title="Panama" value="es-pa">ğŸ‡µğŸ‡¦</option>
  <option title="Paraguay" value="es-py">ğŸ‡µğŸ‡¾</option>
  <option title="Uruguay" value="es-uy">ğŸ‡ºğŸ‡¾</option>
  <option title="Venezuela" value="es-ve">ğŸ‡»ğŸ‡ª</option>
  <option title="Portugual" value="pt-pt">ğŸ‡µğŸ‡¹</option>
  <option title="Brasil" value="pt-br">ğŸ‡§ğŸ‡·</option>
  <option title="Angola" value="pt-ao">ğŸ‡¦ğŸ‡´</option>
  <option title="MoÃ§ambique" value="pt-mz">ğŸ‡²ğŸ‡¿</option>
  <option title="GuinÃ©-Bissau" value="pt-gw">ğŸ‡¬ğŸ‡¼</option>
  <option title="SÃ£o TomÃ© &amp; PrÃ­ncipe" value="pt-st">ğŸ‡¸ğŸ‡¹</option>
  <option title="Cabo Verde" value="pt-cv">ğŸ‡¨ğŸ‡»</option>
  <option title="France" value="fr-fr">ğŸ‡«ğŸ‡·</option>
  <option title="BelgiÃ«" value="nl-be">ğŸ‡§ğŸ‡ª</option>
  <option title="Belgien" value="de-be">ğŸ‡§ğŸ‡ª</option>
  <option title="Belgique" value="fr-be">ğŸ‡§ğŸ‡ª</option>
  <option title="Congo" value="fr-cd">ğŸ‡¨ğŸ‡©</option>
  <option title="Congo" value="fr-cg">ğŸ‡¨ğŸ‡¬</option>
  <option title="CÃ´te dâ€™Ivoire" value="fr-ko">ğŸ‡¨ğŸ‡®</option>
  <option title="Madagascar" value="fr-ko">ğŸ‡²ğŸ‡¬</option>
  <option title="Cameroun" value="fr-cm">ğŸ‡¨ğŸ‡²</option>
  <option title="Cameroon" value="en-cm">ğŸ‡¨ğŸ‡²</option>
  <option title="Burkina Faso" value="fr-bf">ğŸ‡§ğŸ‡«</option>
  <option title="Niger" value="fr-ne">ğŸ‡³ğŸ‡ª</option>
  <option title="Mali" value="fr-ml">ğŸ‡²ğŸ‡±</option>
  <option title="SÃ©nÃ©gal" value="fr-sn">ğŸ‡¸ğŸ‡³</option>
  <option title="HaÃ¯ti" value="fr-ht">ğŸ‡­ğŸ‡¹</option>
  <option title="Benin" value="fr-bj">ğŸ‡§ğŸ‡¯</option>
</select>
<div id="content" class="hidden">
  <div class="idiot"></div>
  <div class="sheep"></div>    
  <div class="labels"></div>
  <div class="fallacies"></div>
  <div class="appeal-tos"></div>
  <div class="topics"></div>
</div>
<div id="loader" class="hidden"></div>
</body>
</html>