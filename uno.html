<!DOCTYPE html>
<html>
  <head>
  <title>New Normal - Corona-Uno</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="opensans.css">
  <link rel="stylesheet" href="crocodile.css">
  <link rel="stylesheet" href="uno.css">
  <link rel="stylesheet" href="uno/cards.css">
  <script src="dialog.js" type="text/javascript"></script>
  <script src="uno/player-hand.js" type="text/javascript"></script>
  <script src="uno/opponent-hand.js" type="text/javascript"></script>
  <script src="uno/argument-card.js" type="text/javascript"></script>
  <script src="uno/no-card.js" type="text/javascript"></script>
  <script src="uno/card-pile.js" type="text/javascript"></script>
  <script src="uno/game-card.js" type="text/javascript"></script>
  <script src="uno/card-back.js" type="text/javascript"></script>
  <script src="uno/label-card.js" type="text/javascript"></script>
  <script src="uno/fallacy-card.js" type="text/javascript"></script>
  <script src="uno/strawman-card.js" type="text/javascript"></script>
  <script src="uno/appeal-to-card.js" type="text/javascript"></script>
  <script src="uno/research-card.js" type="text/javascript"></script>
  <script src="common.js" type="text/javascript"></script>
  <script src="swipy.js" type="text/javascript"></script>
  <script src="fastclick.js" type="text/javascript"></script>
</head>
<body onload="randomMatchId(); load('de')">
  <script src="boardgame.js"></script>
  <script src="uno.js"></script>
  <script src="app.js"></script>
  <script>
    function element(id) {
      return document.getElementById(id)
    }
    function elements(tag) {
      return Array.from(document.getElementsByTagName(tag))
    }
    
    function randomMatchId() {
      element('matchID').value = Math.floor(1000+Math.random()*9000)
    }
    
    async function load(lang) {
      lang = lang.includes('-') ? lang.split('-')[0]: lang
      document.body.lang = lang
      await loadContent(lang)
      element('instructions').innerHTML = await fetchSilent(`${lang}/uno.html`)
      if (!element('game'))
        element('uno').insertAdjacentHTML('afterBegin', `
          <div id="game">
            <div id="players">
            </div>
            <div id="piles">
              <card-pile id="draw-pile" top="I"></card-pile>
              <card-pile id="pile"></card-pile>
            </div>
          </div>`)
    }
    
    let setNameRequestSent = false
    async function sendSetNameRequest(client, playerID) {
      const name = await prompt(`Name for Player ${playerID}?`, '')
      setNameRequestSent = true
      client.sendChatMessage({ message: 'setName', name })
    }
    
    function addOpponentHand(nr, name) {
      element('players').insertAdjacentHTML('beforeEnd', `<opponent-hand cards="8" nr="${nr}" ${name ? `name="${name}"` : ''}></opponent-hand>`)
    }

    async function playWithBot() {
      const lang = document.body.lang
      element('uno').classList.toggle('hidden', false)
      element('config').classList.toggle('hidden', true)
      const clients = [await startLocalClient(lang, '0'), await startLocalClient(lang, '1')]
      await loadContent(lang)
      element('uno').insertAdjacentHTML('beforeEnd', '<player-hand id="hand" nr="0" active ids=""></player-hand>')
      addOpponentHand('1', 'CPU')
      clients[0].moves.setName('0', 'Me')
      clients[0].moves.setName('1', 'CPU')
      const stateHandler = state => {
        if (state && state.ctx.currentPlayer==='0') {
          const client = clients[state.ctx.currentPlayer] 
          element('draw-pile').onclick = event => client.moves.drawCard()
          element('hand').onplay = event => client.moves.playCard(event.detail.index)
          const top = state.G.pile[state.G.pile.length-1]
          element('draw-pile').setAttribute('top', '')
          element('pile').setAttribute('top', top)
          if (client.playerID && client.playerID.length) {
            const name = state.G.names[client.playerID]
            const hand = state.G.hands[client.playerID]
            const idiot = !!(client.playerID%2)
            element('draw-pile').setAttribute('top', idiot ? 'I' : 'S')
            element('hand').setAttribute('ids', hand.join(','))
            element('hand').setAttribute('nr', client.playerID)
            if (name) element('hand').setAttribute('name', name) 
            element('hand').setAttribute('playable', client.playerID===state.ctx.currentPlayer ? hand.filter(card => canBePlayedOn(top, card, idiot)).join(',') : '')
            const opponentId = state.ctx.currentPlayer==='0' ? '1' : '0'
            const opponentHand = elements('opponent-hand')[0]
            opponentHand.setAttribute('nr', opponentId)
            if (state.G.names[opponentId]) opponentHand.setAttribute('name', state.G.names[opponentId])
            opponentHand.setAttribute('cards', state.G.hands[opponentId].length)
          }
        }
      }
      const cpuStateHandler = state => {
        if (state && state.ctx.currentPlayer==='1') {
          const client = clients[state.ctx.currentPlayer]
          const possibleMoves = Uno.ai.enumerate(state.G, state.ctx)
          const randomMoveIndex = Math.floor(Math.random()*possibleMoves.length)
          const move = possibleMoves[randomMoveIndex]
          setTimeout(() => client.moves[move.move](...move.args), 500)
        }
      }
      clients[0].subscribe(stateHandler)
      clients[1].subscribe(cpuStateHandler)
    }
    
    async function play(isHost, numPlayers) {
      const lang = document.body.lang
      const playerID = isHost ? '0' : undefined
      const matchID = element('matchID').value
      element('uno').classList.toggle('hidden', false)
      element('config').classList.toggle('hidden', true)
      element('players').classList.add(`p${numPlayers}`)
      let client = await startClient(lang, isHost, numPlayers, playerID, matchID)
      if (isHost) {
        element('uno').insertAdjacentHTML('beforeEnd', '<player-hand id="hand" nr="0" active ids=""></player-hand>')
        client.moves.setName(playerID, await prompt(`Name for Host Player?`, ''))
        element('draw-pile').onclick = event => client.moves.drawCard()
        element('hand').onplay = event => client.moves.playCard(event.detail.index)
        for (let id=1; id<numPlayers; id++) addOpponentHand(id, '?')
      } else {
        element('uno').insertAdjacentHTML('beforeEnd', '<opponent-hand id="hand" nr="0" name="Host"  cards="8"></opponent-hand>')
      }
      
      const setNameRequest = msg => msg.payload.message==='setName'
      let unsubscribe
      const stateHandler = async state => {
        if (state) {
          const top = state.G.pile[state.G.pile.length-1]
          element('draw-pile').setAttribute('top', '')
          element('pile').setAttribute('top', top)
          if (client.playerID && client.playerID.length) {
            const opponentIds = [...Array(state.ctx.numPlayers).keys()].filter(id => id!=client.playerID) // number!=string
            const name = state.G.names[client.playerID]
            const hand = state.G.hands[client.playerID]
            const idiot = !!(client.playerID%2)
            if (!setNameRequestSent && !name && state.ctx.currentPlayer==="0") {
              await sendSetNameRequest(client, client.playerID)
            }
            if (client.playerID==='0' && state.ctx.currentPlayer==='0') {
              client.chatMessages.filter(setNameRequest).forEach(msg => {
                if (state.G.names[msg.sender]!=msg.payload.name) {
                  client.moves.setName(msg.sender, msg.payload.name)
                }
              }
              )
            }
            element('draw-pile').setAttribute('top', idiot ? 'I' : 'S')
            element('hand').setAttribute('ids', hand.join(','))
            element('hand').setAttribute('nr', client.playerID)
            element('hand').setAttribute('name', name)
            element('hand').setAttribute('playable', client.playerID===state.ctx.currentPlayer ? hand.filter(card => canBePlayedOn(top, card, idiot)).join(',') : '')
            Array.from(element('players').children).forEach((hand, index) => {
              hand.setAttribute('nr', opponentIds[index])
              if (state.G.names[opponentIds[index]]) 
                hand.setAttribute('name', state.G.names[opponentIds[index]])
              hand.setAttribute('cards', state.G.hands[opponentIds[index]].length)
            })
          } else {
            if (!element('players').children.length) { // first call
              document.body.lang = state.G.lang
              await load(state.G.lang)
              const selectablePlayerIds = [...Array(state.ctx.numPlayers).keys()].slice(1)
              selectablePlayerIds.forEach(id => addOpponentHand(id, state.G.names[id]))
              elements('opponent-hand').forEach((child, index) => child.onclick = async event => {
                const selectedPlayerID = ''+(index+1)
                client.stop()
                unsubscribe()
                client = await startClient(state.G.lang, false, numPlayers, selectedPlayerID, matchID)
                unsubscribe = client.subscribe(stateHandler)
                element('uno').removeChild(element('hand'))
                element('uno').insertAdjacentHTML('beforeEnd', `<player-hand id="hand" nr="${selectedPlayerID}" name="${state.G.names[selectedPlayerID]}" active ids=""></player-hand>`)
                element('draw-pile').onclick = event => client.moves.drawCard()
                element('hand').onplay = event => client.moves.playCard(event.detail.index)
              })
            }
          }
        }
      }
      
      unsubscribe = client.subscribe(stateHandler)
    }

  </script>
  <div id="uno" class="hidden"></div>
  <div id="config">
    <h1>Corona-Uno</h1>
    <div className="row">
      <label>
        Language
          <select id="location" onchange="load(event.target.value)">
            <option title="Deutschland" value="de-de">ðŸ‡©ðŸ‡ª</option>
            <option title="Ã–sterreich" value="de-at">ðŸ‡¦ðŸ‡¹</option>
            <option title="Schweiz" value="de-ch">ðŸ‡¨ðŸ‡­</option>
            <option title="Svizzera" value="it-ch">ðŸ‡¨ðŸ‡­</option>
            <option title="Suisse" value="fr-ch">ðŸ‡¨ðŸ‡­</option>
            <option title="Danmark" value="da-da">ðŸ‡©ðŸ‡°</option>
            <option title="Liechtenstein" value="de-li">ðŸ‡±ðŸ‡®</option>
            <option title="Italia" value="it-it">ðŸ‡®ðŸ‡¹</option>
            <option title="Italien" value="de-it">ðŸ‡®ðŸ‡¹</option>
            <option title="San Marino" value="it-sm">ðŸ‡¸ðŸ‡²</option>
            <option title="CittÃ  del Vaticano" value="it-va">ðŸ‡»ðŸ‡¦</option>
            <option title="United States" value="en-us">ðŸ‡ºðŸ‡¸</option>
            <option title="United Kingdom" value="en-gb">ðŸ‡¬ðŸ‡§</option>
            <option title="Australia" value="en-au">ðŸ‡¦ðŸ‡º</option>
            <option title="New Zealand" value="en-nz">ðŸ‡³ðŸ‡¿</option>
            <option title="Canada" value="en-ca">ðŸ‡¨ðŸ‡¦</option>
            <option title="Canada" value="fr-ca">ðŸ‡¨ðŸ‡¦</option>
            <option title="Polska" value="pl-pl">ðŸ‡µðŸ‡±</option>
            <option title="Antigua and Barbuda" value="en-ag">ðŸ‡¦ðŸ‡¬</option>
            <option title="The Bahamas" value="en-bs">ðŸ‡§ðŸ‡¸</option>
            <option title="Barbados" value="en-bb">ðŸ‡§ðŸ‡§</option>
            <option title="Belize" value="en-bz">ðŸ‡§ðŸ‡¿ </option>
            <option title="Dominica" value="en-dm">ðŸ‡©ðŸ‡²</option>
            <option title="Grenada" value="en-gd">ðŸ‡¬ðŸ‡©</option>
            <option title="Guyana" value="en-gy">ðŸ‡¬ðŸ‡¾</option>
            <option title="Ireland" value="en-ie">ðŸ‡®ðŸ‡ª</option>
            <option title="Jamaica" value="en-jm">ðŸ‡¯ðŸ‡²</option>
            <option title="Malta" value="en-mt">ðŸ‡²ðŸ‡¹</option>
            <option title="St Kitts and Nevis" value="en-kn">ðŸ‡°ðŸ‡³</option>
            <option title="St Lucia" value="en-lc">ðŸ‡±ðŸ‡¨</option>
            <option title="St Vincent and the Grenadines" value="en-vc">ðŸ‡»ðŸ‡¨</option>
            <option title="Trinidad and Tobago" value="en-tt">ðŸ‡¹ðŸ‡¹</option>
            <option title="EspaÃ±a" value="es-es">ðŸ‡ªðŸ‡¸</option>
            <option title="Cuba" value="es-cu">ðŸ‡¨ðŸ‡º</option>
            <option title="PerÃº" value="es-pe">ðŸ‡µðŸ‡ª</option>
            <option title="Chile" value="es-cl">ðŸ‡¨ðŸ‡±</option>
            <option title="MÃ©xico" value="es-mx">ðŸ‡²ðŸ‡½</option>
            <option title="Puerto Rico" value="es-pr">ðŸ‡µðŸ‡·</option>
            <option title="Argentina" value="es-ar">ðŸ‡¦ðŸ‡·</option>
            <option title="Bolivia" value="es-bo">ðŸ‡§ðŸ‡´</option>
            <option title="Colombia" value="es-co">ðŸ‡¨ðŸ‡´</option>
            <option title="Costa Rica" value="es-cr">ðŸ‡¨ðŸ‡·</option>
            <option title="RepÃºblica Dominicana" value="es-do">ðŸ‡©ðŸ‡´</option>
            <option title="Ecuador" value="es-ec">ðŸ‡ªðŸ‡¨</option>
            <option title="El Salvador" value="es-sv">ðŸ‡¸ðŸ‡»</option>
            <option title="Guinea Ecuatorial" value="es-gq">ðŸ‡¬ðŸ‡¶</option>
            <option title="Guatemala" value="es-gt">ðŸ‡¬ðŸ‡¹</option>
            <option title="Honduras" value="es-hn">ðŸ‡­ðŸ‡³</option>
            <option title="Nicaragua" value="es-ni">ðŸ‡³ðŸ‡®</option>
            <option title="Panama" value="es-pa">ðŸ‡µðŸ‡¦</option>
            <option title="Paraguay" value="es-py">ðŸ‡µðŸ‡¾</option>
            <option title="Uruguay" value="es-uy">ðŸ‡ºðŸ‡¾</option>
            <option title="Venezuela" value="es-ve">ðŸ‡»ðŸ‡ª</option>
            <option title="Portugual" value="pt-pt">ðŸ‡µðŸ‡¹</option>
            <option title="Brasil" value="pt-br">ðŸ‡§ðŸ‡·</option>
            <option title="Angola" value="pt-ao">ðŸ‡¦ðŸ‡´</option>
            <option title="MoÃ§ambique" value="pt-mz">ðŸ‡²ðŸ‡¿</option>
            <option title="GuinÃ©-Bissau" value="pt-gw">ðŸ‡¬ðŸ‡¼</option>
            <option title="SÃ£o TomÃ© &amp; PrÃ­ncipe" value="pt-st">ðŸ‡¸ðŸ‡¹</option>
            <option title="Cabo Verde" value="pt-cv">ðŸ‡¨ðŸ‡»</option>
            <option title="France" value="fr-fr">ðŸ‡«ðŸ‡·</option>
            <option title="BelgiÃ«" value="nl-be">ðŸ‡§ðŸ‡ª</option>
            <option title="Belgien" value="de-be">ðŸ‡§ðŸ‡ª</option>
            <option title="Belgique" value="fr-be">ðŸ‡§ðŸ‡ª</option>
            <option title="Congo" value="fr-cd">ðŸ‡¨ðŸ‡©</option>
            <option title="Congo" value="fr-cg">ðŸ‡¨ðŸ‡¬</option>
            <option title="CÃ´te dâ€™Ivoire" value="fr-ko">ðŸ‡¨ðŸ‡®</option>
            <option title="Madagascar" value="fr-ko">ðŸ‡²ðŸ‡¬</option>
            <option title="Cameroun" value="fr-cm">ðŸ‡¨ðŸ‡²</option>
            <option title="Cameroon" value="en-cm">ðŸ‡¨ðŸ‡²</option>
            <option title="Burkina Faso" value="fr-bf">ðŸ‡§ðŸ‡«</option>
            <option title="Niger" value="fr-ne">ðŸ‡³ðŸ‡ª</option>
            <option title="Mali" value="fr-ml">ðŸ‡²ðŸ‡±</option>
            <option title="SÃ©nÃ©gal" value="fr-sn">ðŸ‡¸ðŸ‡³</option>
            <option title="HaÃ¯ti" value="fr-ht">ðŸ‡­ðŸ‡¹</option>
            <option title="Benin" value="fr-bj">ðŸ‡§ðŸ‡¯</option>
          </select>
      </label>
    <hr>
      <label>
        Match#
        <input id="matchID" type="text" maxlength="4" minlength="4" size="5">
      </label>
    </div>
      <label>
        Host
    <button onclick="play(true, 2)">2</button>
    <button onclick="play(true, 4)">4</button>
    <button onclick="play(true, 6)">6</button>
    <button onclick="play(true, 8)">8</button>
    <button onclick="play(true, 10)">10</button>
        Guest
    <button onclick="play(false)">Join</button>
      </label>
    <hr>
      <label>
        Local
    <button onclick="playWithBot()">Against Bot</button>
      </label>
    <div id="instructions"></div>
  </div>
<div id="content" class="hidden">
</div>
<div id="loader" class="hidden"></div>
</body>
</html>